<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EnigmaIOT: howto</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo text inside.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EnigmaIOT
   &#160;<span id="projectnumber">0.9.8</span>
   </div>
   <div id="projectbrief">Secure sensor and gateway platform based on ESP8266 and ESP32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">howto </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document will serve as a guide to start working with EnigmaIOT, enabling you to develop your own secure sensor network easily, with a few additional lines of code compared with a regular Arduino program.</p>
<h1>What you need</h1>
<h3>Gateway</h3>
<p>Any ESP32 or ESP8266 will do the job. Anyway, it is always recommended to use an <b>ESP32</b> board because having much more RAM it will be more stable along time.</p>
<p><b>Notice that it is not possible to configure any node if you don't have a gateway working nearby.</b></p>
<h3>MQTT broker</h3>
<p>You need to use a MQTT broker (or server). Any public or private will do the job. As EnigmaIOT is focused on privacy I advise to install your own MQTT private broker. You can do it on any home server or Raspberry Pi, or even in a virtual private server. Installing and configuring a broker is out of scope of this guide but there are plenty of good and easy guides online.</p>
<p>A good choice for a MQTT broker is <a href="https://mosquitto.org">Eclipse Mosquitto</a>.</p>
<p>Don't forget to add a user and password to broker at least. EnigmaIOT supports MQTT brokers with TLS encryption. If you expose your broker to the public Internet adding TLS to your setup will improve privacy and security, so it is highly encouraged.</p>
<p>Using MQTT enables you to use a wide range or solutions to process, display information and manage your EnigmaIOT nodes. Good choices are <a href="https://nodered.org">Node-Red</a> and <a href="https://www.home-assistant.io">Home Assistant</a>, although you can use any software that is able to communicate with a MQTT broker, or any combination of them.</p>
<h2>Required External libraries</h2>
<p>All examples have a <code>platformio.ini</code> file so that they can be compiled using PlatformIO without any additional requirement.</p>
<p>If you use Arduino IDE instead, you have to install all these libraries into your environment:</p>
<ul>
<li>ESPAsyncTCP &ndash; <a href="https://github.com/me-no-dev/ESPAsyncTCP">https://github.com/me-no-dev/ESPAsyncTCP</a> **(Required only for ESP8266)**</li>
<li>AsyncTCP &ndash; <a href="https://github.com/me-no-dev/AsyncTCP">https://github.com/me-no-dev/AsyncTCP</a> **(Required only for ESP32)**</li>
<li>ESPAsyncWebServer &ndash; <a href="https://github.com/me-no-dev/ESPAsyncWebServer">https://github.com/me-no-dev/ESPAsyncWebServer</a></li>
<li>ESPAsyncWiFiManager &ndash; <a href="https://github.com/alanswx/ESPAsyncWiFiManager">https://github.com/alanswx/ESPAsyncWiFiManager</a> version &gt; 0.22</li>
<li>Arduino Crypto Library &ndash; <a href="https://github.com/gmag11/CryptoArduino">https://github.com/gmag11/CryptoArduino</a> forked and formatted from <a href="https://github.com/rweather">https://github.com/rweather</a></li>
<li>PubSubClient &ndash; <a href="https://github.com/knolleary/pubsubclient">https://github.com/knolleary/pubsubclient</a></li>
<li>CayenneLPP &ndash; <a href="https://github.com/sabas1080/CayenneLPP">https://github.com/sabas1080/CayenneLPP</a> version &gt; 1.0.2</li>
<li>ArduinoJSON 6 &ndash; <a href="https://github.com/bblanchon/ArduinoJson">https://github.com/bblanchon/ArduinoJson</a> version &gt; 6.0.0</li>
</ul>
<h1>How to start with EnigmaIOT MQTT Gateway</h1>
<h3>Install Gateway code on ESP32 or ESP8266</h3>
<p>Code for gateway is included as an example on EnigmaIOT repository, as <code>EnigmaIOTGatewayMQTT</code>. You can find it <a href="https://github.com/gmag11/EnigmaIOT/tree/master/examples/EnigmaIOTGatewayMQTT">here</a>.</p>
<p>It may be used as it is. There is no need to modify it to be able to customize to your needs. Everything is done during first configuration.</p>
<p>You can use binary file included in release as an attachment or compile it by yourself.</p>
<h3>Loading binary file</h3>
<p>You will need <a href="https://github.com/espressif/esptool">Espressif esptool</a> utility to flash binary file on your ESP32 or ESP8266. If your system has Python and pip installed you can install esptool by running</p>
<div class="fragment"><div class="line">pip install esptool</div>
</div><!-- fragment --><p>Esptool will detect your board type and the port on which it is attached to so command line will be as simple as this:</p>
<p>It your MQTT broker uses TLS</p>
<div class="fragment"><div class="line">python esptool.py write_flash 0 EnigmaIOT-Gateway-ESP32-SSL_MQTT.bin</div>
</div><!-- fragment --><p>If your MQTT broker does not use encrypted communication</p>
<div class="fragment"><div class="line">python esptool.py write_flash 0 EnigmaIOT-Gateway-ESP32-Plain_MQTT.bin</div>
</div><!-- fragment --><p>If you have a ESP8266 (MQTT encryption is not supported)</p>
<div class="fragment"><div class="line">python esptool.py write_flash 0 EnigmaIOT-Gateway-ESP8266.bin</div>
</div><!-- fragment --><h3>Configuring your gateway</h3>
<p>First time you run EnigmaIOT gateway it will behave as a WiFi access point with name <code>EnigmaIOTGateway</code>. Connect your smartphone or computer to it.</p>
<p>A web browser should be open automatically pointing to configuration portal. If it is not the case you can access it opening <a href="http://192.168.4.1">http://192.168.4.1</a>.</p>
<p>You should see something like this:</p>
<p><img src="https://raw.githubusercontent.com/gmag11/EnigmaIOT/master/img/EnigmaIOTGateway_config_portal.png" alt="" style="zoom:50%;" class="inline"/></p>
<p>Click on <code>Configure WiFi</code> and board will scan networks. Select yours and continue filling all fields</p>
<p><img src="https://raw.githubusercontent.com/gmag11/EnigmaIOT/master/img/EnigmaIOTGateway_wifi_selection.png" alt="image-20210703000533470" style="zoom: 50%;" class="inline"/></p>
<p>Fields explanation:</p>
<p><b>SSID</b>: Name of your home WiFi network.</p>
<p><b>WiFi Password</b>: Your home WiFi password.</p>
<p><b>Network Key</b>: Network key for your EnigmaIOT network. All nodes and gateway must share this key. Choose a secure password and keep it safe.</p>
<p><b>Network Channel</b>: EnigmaIOT gateway initial channel. This is not relevant for MQTT gateway as it will use the same as your WiFi network.</p>
<p><b>Network Name</b>: EnigmaIOT network name. This identify your network. This name will be used as root for all MQTT messages to and from this gateway.</p>
<p><b>MQTT broker address</b>: IP address or hostname where MQTT broker is listening on</p>
<p><b>TCP port</b>: TCP port used by MQTT broker. 8883 is normally used by brokers with TLS encryption configured. 1883 is used otherwise.</p>
<p><b>MQTT username</b>: Username configured on MQTT broker.</p>
<p><b>MQTT password</b>: User password.</p>
<p>When you click <code>save</code> button and boards successfully connects to your WiFi network it reboots to start working as a real EnigmaIOT gateway.</p>
<p>Now you are ready to start your own EnigmaIOT network.</p>
<h3>Customizing gateway firmware</h3>
<p>Although you can use gateway code as it is. There are some customizations available for experienced users.</p>
<h4><a class="el" href="EnigmaIOTGatewayMQTT_8ino.html" title="MQTT Gateway based on EnigmaIoT over ESP-NOW.">EnigmaIOTGatewayMQTT.ino</a></h4>
<p><code>LED_BUILTIN</code>: On many ESP32 boards, built in LED is connected to Pin 5. On EnigmaIOTGatewayMQTT, LED is used to signal configuration mode (flashing LED) and to show activity from nodes. If your board uses a different pin you can set it here. You may use different LEDs to signal received or sent message, In that case you may set <code>BLUE_LED</code> and <code>RED_LED</code>.</p>
<h4><a class="el" href="dstrootca_8h.html">dstrootca.h</a></h4>
<p>If you use TLS to encrypt communication with MQTT broker, then you must provide the root certificate used to check server certificate. This varies between different certificate providers. Included certificate works with <a href="https://letsencrypt.org">Let's encrypt</a>. If you use a different provider or you have setup your own public key infrastructure you need to copy your CA certificate in <a href="https://knowledge.digicert.com/quovadis/ssl-certificates/ssl-general-topics/what-is-pem-format.html">PEM format</a> assigned to <code>DSTroot_CA</code> variable.</p>
<p>You can use <a href="https://www.sslchecker.com/certdecoder">certificate decoder from SSLChecker.com</a> to dump certificate data, as expiration date.</p>
<h4>EnigmaIOTconfig.h</h4>
<p>This file is on library code directory. There are some settings that you can tweak there before compilation. There are explanation for every parameter on file itself. Although it is safe to adjust these settings some combinations may lead your gateway to not be able to communicate with nodes. I do not recommend tweaking settings that you don't understand clearly.</p>
<p><code>NUM_NODES</code> parameter is used to configure the maximum number of nodes. It is set to 35 by default that should be enough for most users. You may increase it if you expect your network to grow above this limit.</p>
<p>For ESP32 boards a limit of 100 or 200 nodes is safe, but ESP8266 may not have enough memory so if you find frequent reboots after setting this restore it to the default value.</p>
<h1>How to develop a node with EnigmaIOT on ESP32 or ESP8266</h1>
<p>EnigmaIOT is designed to hide all complexity behind, so that anyone that is barely familiar with Arduino environment is able to develop a node.</p>
<h3>Bare basic code</h3>
<p>Simplest node code may be something like this.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;EnigmaIOTNode.h&gt; // Include EnigmaIOT node library</div>
<div class="line">#include &lt;espnow_hal.h&gt;    // Add ESP-NOW subsystem</div>
<div class="line">void setup () {</div>
<div class="line">    EnigmaIOTNode.begin (&amp;Espnow_hal); // Start node code</div>
<div class="line">    char msg[] = &quot;20&quot;; // Build a message to send</div>
<div class="line">    EnigmaIOTNode.sendData ((uint8_t*)msg, sizeof (msg) - 1, RAW); // Send data as RAW</div>
<div class="line">    EnigmaIOTNode.sleep (); // Request node to sleep</div>
<div class="line">}</div>
<div class="line">void loop () {</div>
<div class="line">    EnigmaIOTNode.handle (); // Don&#39;t forget this</div>
<div class="line">}</div>
</div><!-- fragment --><p>If you use <a href="https://platformio.org">PlatformIO</a> IDE you may use this platformio.ini</p>
<div class="fragment"><div class="line">[env:d1_mini_pro]</div>
<div class="line">platform = espressif8266</div>
<div class="line">board = d1_mini_pro</div>
<div class="line">framework = arduino</div>
<div class="line">lib_deps =</div>
<div class="line">   ESPAsyncWiFiManager</div>
<div class="line">   ESP Async WebServer</div>
<div class="line">   ArduinoJson</div>
<div class="line">   https://github.com/gmag11/CryptoArduino.git</div>
<div class="line">   https://github.com/gmag11/EnigmaIOT.git</div>
</div><!-- fragment --><h3>First node configuration</h3>
<p>In the same way as we did with gateway, when node starts for first time it announces itself as a WiFi access point with name EnigmaIoTNode followed by chipID.</p>
<p>When you connect to this AP without password you get a web page like this:</p>
<p><img src="https://raw.githubusercontent.com/gmag11/EnigmaIOT/img/EnigmaIOTNode_config_portal.png" alt="image-20210704121322147" style="zoom:50%;" class="inline"/></p>
<p>Click on <code>Configure WiFi</code> button and you will get the list of WiFi networks around. It is important not to select your home WiFi network here. It is not what an EnigmaIOT node needs. You should select the one whose name is you EnigmaIOT network name. This comes from your EnigmaIOT gateway.</p>
<p>This AP needs a password it is the one that you configured as Network key in your gateway.</p>
<p><img src="https://raw.githubusercontent.com/gmag11/EnigmaIOT/master/img/EnigmaIOTNode_wifi_selection.png" alt="image-20210704121626137" style="zoom:50%;" class="inline"/></p>
<p>You need to fill this settings in:</p>
<p><b>SSID</b>: Your network name (as configured in gateway)</p>
<p><b>Password</b>: Your network key (as configured in gateway)</p>
<p><b>Sleep time</b>: A node may be designed to sleep after sending a message. In that case this is the default sleep time in seconds. If your node does not go to sleep mode, then this setting is ignored.</p>
<p><b><a class="el" href="classNode.html" title="Class definition for a single sensor Node.">Node</a> Name</b>: This is your node name. It must be unique in your network. It a gateway find a node with duplicate name this name will be ignored and will use its MAC address instead.</p>
<hr  />
<p>After information is saved, node checks that it can connect Gateway WiFi AP successfully. If so, it reboots and start sending data.</p>
<p>Using EnigmaIOTGatewayMQTT you will get a MQTT message every time your node sends data.</p>
<div class="fragment"><div class="line">EnigmaIOT/SimpleNode/data   20</div>
</div><!-- fragment --><p>Topic format is always the same:</p>
<div class="fragment"><div class="line">&lt;NetworkName&gt;/&lt;NodeName&gt;/data</div>
</div><!-- fragment --><h1>Developing advanced nodes using JSONController template</h1>
<p>If you need to build a node you may start coding from scratch as it is shown before. Additionally you can use a Template so many features are already implemented transparently:</p>
<ul>
<li>Sleep management</li>
<li>Connection and disconnection handling</li>
<li>Send data as JSON object</li>
<li><a href="https://www.home-assistant.io">Home Assistant</a> auto discovery integration feature.</li>
<li>WiFi Manager custom parameters</li>
<li>Integrated <a href="https://github.com/gmag11/FailSafeMode">fail safe mode</a></li>
</ul>
<h3>Designing sensor algorithm</h3>
<p>JSON Controller wraps EnigmaIOT node with additional features. It is implemented as a cpp and h files that contains <code>setup ()</code> and <code>loop ()</code> functions. You should use them instead main setup and loop.</p>
<p>First step I recommend is coding a simple sketch that deals with your hardware (sensors, actuators) as a regular Arduino program. To illustrate this I will use EnigmaIOT-Sensor-Controller example. It is a node that uses a DS18B20 temperature sensor that reads temperature value, sends it and then sleeps until next measurement.</p>
<p>So starting code could look like this</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;DallasTemperature.h&gt;</div>
<div class="line"> </div>
<div class="line">#define ONE_WIRE_BUS 4 // I/O pin used to communicate with sensor</div>
<div class="line"> </div>
<div class="line">//----------------- GLOBAL VARIABLES -----------------</div>
<div class="line">OneWire* oneWire;</div>
<div class="line">DallasTemperature* sensors;</div>
<div class="line">DeviceAddress insideThermometer;</div>
<div class="line">bool tempSent = false; // True when</div>
<div class="line">float tempC;</div>
<div class="line">//----------------- GLOBAL VARIABLES -----------------</div>
<div class="line"> </div>
<div class="line">bool sendTemperature (float temp) { // Mock function. This will later be adapted to send an EnigmaIOT message</div>
<div class="line">    Serial.printf (&quot;Temperarure: %f\n&quot;, temp);</div>
<div class="line">    return true;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup () {</div>
<div class="line">    Serial.begin (115200); // Only for this test</div>
<div class="line">    </div>
<div class="line">    //----------------- USER CODE -----------------</div>
<div class="line">    oneWire = new OneWire (ONE_WIRE_BUS);</div>
<div class="line">    sensors = new DallasTemperature (oneWire);</div>
<div class="line">    sensors-&gt;begin ();</div>
<div class="line">    sensors-&gt;setWaitForConversion (false);</div>
<div class="line">    sensors-&gt;requestTemperatures ();</div>
<div class="line">    </div>
<div class="line">    time_t start = millis (); </div>
<div class="line">    </div>
<div class="line">    while (!sensors-&gt;isConversionComplete ()) {</div>
<div class="line">        delay (0);</div>
<div class="line">    }</div>
<div class="line">    Serial.printf (&quot;Conversion completed in %lld ms\n&quot;, millis () - start);</div>
<div class="line">    tempC = sensors-&gt;getTempCByIndex (0);</div>
<div class="line">    //----------------- USER CODE END -------------</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop () {</div>
<div class="line">    //----------------- USER CODE -----------------</div>
<div class="line">    if (!tempSent) { </div>
<div class="line">        if (sendTemperature (tempC)) { // First time this will be executed</div>
<div class="line">            tempSent = true;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    //----------------- USER CODE END -------------</div>
<div class="line">    else {</div>
<div class="line">        ESP.deepSleep(10000); // Next time deep sleep mode will be requested automatically. Only for testing</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>When this code has the functionality that you need and it is tested you can follow with integration on EnigmaIOT JSON Controller code.</p>
<h3>Code integration into EnigmaIOT</h3>
<p>To develop a new JSONController node you need to use <a href="https://github.com/gmag11/EnigmaIOT/tree/dev/examples/EnigmaIOT-Json-Controller-Template">JSONController template</a> example as starting point.</p>
<p>I will follow the process to get to the point implemented in <a href="https://github.com/gmag11/EnigmaIOT/tree/dev/examples/EnigmaIOT-Sensor-Controller"><b>EnigmaIOT-Sensor-Controller</b></a>.</p>
<p>You need to follow these steps:</p>
<h4>Rename JSON Controller files and class</h4>
<p>It is recommended to rename cpp and h files so that its name is coherent with the function they have. Following this, <code><a class="el" href="BasicController_8h.html">BasicController.h</a>/cpp</code> will become <code><a class="el" href="ds18b20Controller_8h.html">ds18b20Controller.h</a>/cpp</code>. Then edit <code><a class="el" href="classCONTROLLER__CLASS__NAME.html">CONTROLLER_CLASS_NAME</a></code> and <code>CONTROLLER_NAME</code> on <code><a class="el" href="ds18b20Controller_8h.html">ds18b20Controller.h</a></code> like this:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#define CONTROLLER_CLASS_NAME ds18b20Controller</div>
<div class="line">static const char* CONTROLLER_NAME = &quot;DS18B20 controller&quot;;</div>
</div><!-- fragment --><p>and two first lines to:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#ifndef _DS18B20CONTROLLER_h</div>
<div class="line">#define _DS18B20CONTROLLER_h</div>
</div><!-- fragment --><h4>Define if your node should sleep</h4>
<p>If you want to design a node that is powered with batteries, then it should enter into deep sleep mode after sending its data. To do so you only need to set <code>SLEEPY</code> to 1 or <code>true</code>. You need to do so on main cpp file. In sensor controller example, it is <code><a class="el" href="EnigmaIOT-Sensor-Controller_8ino.html">EnigmaIOT-Sensor-Controller.ino</a></code>.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#define SLEEPY 1 // Set it to 1 if your node should sleep after sending data</div>
</div><!-- fragment --><p>It you don't need sleep function leave it as 0.</p>
<p>Notice that non sleepy nodes have an additional time synchronization function that is not available for nodes that enter deep sleep mode. This allows you to add features as timer or time synchronized tasks in different nodes.</p>
<h4>Copy global variables as class parameters</h4>
<p>You need to add all global variables defined in Arduino code as JSON Controller class parameters in <code><a class="el" href="ds18b20Controller_8h.html">ds18b20Controller.h</a></code>.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">class CONTROLLER_CLASS_NAME : EnigmaIOTjsonController {</div>
<div class="line">protected:</div>
<div class="line">    // --------------------------------------------------</div>
<div class="line">    // add all parameters that your project needs here</div>
<div class="line">    // --------------------------------------------------</div>
<div class="line">    OneWire* oneWire;</div>
<div class="line">    DallasTemperature* sensors;</div>
<div class="line">    DeviceAddress insideThermometer;</div>
<div class="line">    bool tempSent = false;</div>
<div class="line">    float tempC;</div>
</div><!-- fragment --><h4>Add custom libraries</h4>
<p>If your code needs custom libraries you may add them on JSON controller header file (<code><a class="el" href="ds18b20Controller_8h.html">ds18b20Controller.h</a></code>)</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">// --------------------------------------------------</div>
<div class="line">// You may define data structures and constants here</div>
<div class="line">// --------------------------------------------------</div>
<div class="line">#include &lt;DallasTemperature.h&gt;</div>
</div><!-- fragment --><h4>Add custom function as class methods</h4>
<p>In the same way you should add custom functions like <code>sendTemperature ()</code> as class methods. You need to define them in <code><a class="el" href="ds18b20Controller_8h.html">ds18b20Controller.h</a></code></p>
<div class="fragment"><div class="line">{c++}</div>
<div class="line">   // ------------------------------------------------------------</div>
<div class="line">   // You may add additional method definitions that you need here</div>
<div class="line">   // ------------------------------------------------------------</div>
<div class="line"> </div>
<div class="line">   bool sendTemperature (float temp);</div>
</div><!-- fragment --><h4>Include Home Assistant integration</h4>
<p>If you like to integrate your node into HomeAssistant you may include the corresponding header file.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#if SUPPORT_HA_DISCOVERY    </div>
<div class="line">#include &lt;haSensor.h&gt;</div>
<div class="line">#endif</div>
</div><!-- fragment --><p>You need to choose the file to include according node function. As this will be a sensor node we should use <code><a class="el" href="haSensor_8h.html" title="Home Assistant sensor integration.">haSensor.h</a></code>. If your node uses different profiles you can include several HA integration header files. For instance, a smart metering plug is a sensor (Power measurement) and binary switch (ON-OFF).</p>
<p>Then you need to add configuration on cpp file. In sensor controller node example it is</p>
<div class="fragment"><div class="line">{c++}</div>
<div class="line">   // *******************************</div>
<div class="line">   // Add your characteristics here</div>
<div class="line">   // There is no need to futher modify this function</div>
<div class="line">   haEntity-&gt;setNameSufix (&quot;temp&quot;);</div>
<div class="line">   haEntity-&gt;setDeviceClass (sensor_temperature);</div>
<div class="line">   haEntity-&gt;setExpireTime (3600);</div>
<div class="line">   haEntity-&gt;setUnitOfMeasurement (&quot;ÂºC&quot;);</div>
<div class="line">   haEntity-&gt;setValueField (&quot;temp&quot;);</div>
<div class="line">   // *******************************</div>
</div><!-- fragment --><h4>Add defines</h4>
<p>All needed defines and constants that you need in your code may be added at the beginning of controller cpp file. You can add them to header file instead but it is a good practice to restrict its code visibility.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">// -----------------------------------------</div>
<div class="line">// You may add some global variables you need here,</div>
<div class="line">// like serial port instances, I2C, etc</div>
<div class="line">// -----------------------------------------</div>
<div class="line"> </div>
<div class="line">#define ONE_WIRE_BUS 4</div>
</div><!-- fragment --><h4>Correct JSON controller header include in cpp file</h4>
<p>If you modified file and class names you will need to update include in cpp file</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &quot;ds18b20Controller.h&quot;</div>
</div><!-- fragment --><h4>Add <code><a class="el" href="EnigmaIOT-Button-Controller_8ino.html#a4fc01d736fe50cf5b977f755b675f11d">setup()</a></code> and <code><a class="el" href="EnigmaIOT-Button-Controller_8ino.html#afe461d27b9c48d5921c00d521181f12f">loop()</a></code>code to class method</h4>
<p>Now, you can start integrating your code into JSON controller class. You need to copy setup and loop code into corresponding methods in JSON controller class.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">void CONTROLLER_CLASS_NAME::setup (EnigmaIOTNodeClass* node, void* data) {</div>
<div class="line">    enigmaIotNode = node;</div>
<div class="line"> </div>
<div class="line">    // Send a &#39;hello&#39; message when initalizing is finished for non sleepy nodes</div>
<div class="line">    if (!enigmaIotNode-&gt;getNode ()-&gt;getSleepy ()) {</div>
<div class="line">        if (!(enigmaIotNode-&gt;getNode ()-&gt;getSleepy ())) {</div>
<div class="line">            sendStartAnouncement ();  // Disable this if node is sleepy</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    // Send hello end</div>
<div class="line">    </div>
<div class="line">    // You do node setup here. Use it as it was the normal setup() Arduino function</div>
<div class="line"> </div>
<div class="line">    oneWire = new OneWire (ONE_WIRE_BUS);</div>
<div class="line">    sensors = new DallasTemperature (oneWire);</div>
<div class="line">    sensors-&gt;begin ();</div>
<div class="line">    sensors-&gt;setWaitForConversion (false);</div>
<div class="line">    sensors-&gt;requestTemperatures ();</div>
<div class="line">    time_t start = millis ();</div>
<div class="line"> </div>
<div class="line">    while (!sensors-&gt;isConversionComplete ()) {</div>
<div class="line">        delay (0);</div>
<div class="line">    }</div>
<div class="line">    DEBUG_WARN (&quot;Conversion completed in %d ms&quot;, millis () - start);</div>
<div class="line">    tempC = sensors-&gt;getTempCByIndex (0);</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line"> {c++}</div>
<div class="line">void CONTROLLER_CLASS_NAME::loop () {</div>
<div class="line"> </div>
<div class="line">    // If your node stays allways awake do your periodic task here</div>
<div class="line"> </div>
<div class="line">    // You can send your data as JSON. This is a basic example</div>
<div class="line"> </div>
<div class="line">    if (!tempSent &amp;&amp; enigmaIotNode-&gt;isRegistered()) {</div>
<div class="line">        if (sendTemperature (tempC)) {</div>
<div class="line">            tempSent = true;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">}</div>
</div><!-- fragment --><p>Notice that I've added <code>enigmaIotNode-&gt;isRegistered()</code> to send data only if node has already registered with Gateway and not losing messages.</p>
<h4>Add custom functions as class methods</h4>
<p>Add every custom function you have used as method into the class. You already added definitions in header file before. Now add the implementation to cpp file</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">bool CONTROLLER_CLASS_NAME::sendTemperature (float temp) {</div>
<div class="line">    const size_t capacity = JSON_OBJECT_SIZE (2);</div>
<div class="line">    DynamicJsonDocument json (capacity);</div>
<div class="line">    json[&quot;temp&quot;] = temp;</div>
<div class="line"> </div>
<div class="line">    return sendJson (json);</div>
<div class="line">}</div>
</div><!-- fragment --><p>This creates a JSON object with all data you need and sends it to gateway using <code>sendJson ()</code> method. Notice that EnigmaIOT uses esp-now protocol to communicate nodes with gateway. This implies a limit of 250 bytes per message, including headers. So, if you have problem receiving messages or you get partial data check the length of your payload.</p>
<h4>Additional functions</h4>
<p>There are a few of additional functions. Check other controller examples to learn how to use them.</p>
<ul>
<li><a href="https://github.com/gmag11/EnigmaIOT/tree/master/examples/EnigmaIOT-Button-Controller"><b>EnigmaIOTButtonController</b></a>: <a class="el" href="classNode.html" title="Class definition for a single sensor Node.">Node</a> that send messages when a button is pressed. (Non sleepy)</li>
<li><a href="https://github.com/gmag11/EnigmaIOT/tree/master/examples/EnigmaIOT-DashButton-Controller"><b>EnigmaIOT-DashButton-Controller</b></a>: <a class="el" href="classNode.html" title="Class definition for a single sensor Node.">Node</a> that wakes from deep sleep when a button is pressed, send its message and sleeps indefinitely. (Sleepy)</li>
<li><a href="https://github.com/gmag11/EnigmaIOT/tree/master/examples/EnigmaIOT-Led-Controller"><b>EnigmaIOT-Led-Controller</b></a>: <a class="el" href="classNode.html" title="Class definition for a single sensor Node.">Node</a> that controls a singled light or LED (Non sleepy)</li>
<li><a href="https://github.com/gmag11/EnigmaIOT/tree/master/examples/EnigmaIOT-Sensor-Controller"><b>EnigmaIOT-Sensor-Controller</b></a>: <a class="el" href="classNode.html" title="Class definition for a single sensor Node.">Node</a> that send value from a DS18B20 temperature sensor regularly. (Sleepy)</li>
<li><a href="https://github.com/gmag11/EnigmaIOT/tree/master/examples/EnigmaIOT-SmartSwitch-Controller"><b>EnigmaIOT-SmartSwitch-Controller</b></a>: Smart switch that uses a button to toggle a relay. It sends status messages regularly and on every toggle action. It listens for messages to allow remote control. (Non sleepy)</li>
</ul>
<h5>Listen for incoming messages from gateway</h5>
<p>Some kind of nodes as light controllers or smart switches should accept incoming messages to control different parameters. This can be achieved with <code>processRxCommand</code> and <code>sendCommandResp</code>.</p>
<h5>Notice when a node is connected or disconnected from EnigmaIOT network</h5>
<p>It may be useful for a node to know if it is actually connected to gateway. To implement this you may fill these two methods: <code>connectInform</code> and <code>disconnectInform</code>.</p>
<h5>Save and recover custom persistent configuration</h5>
<p>Sometimes you need some data to be stored persistently on node sleeps or power cycles. There are a couple methods that may be implemented to achieve this: <code>loadConfig</code> and <code>saveConfig</code>.</p>
<h5>Add custom parameters to configuration portal</h5>
<p>You may want to add your own configuration fields to first configuration web portal on node. You can get this by implementing <code>configManagerStart</code> and <code>configManagerExit</code>.</p>
<h4>Advanced tuning</h4>
<p>There are some advanced settings on <code>EnigmaIOTconfig.h</code>. You may modify this data but it is important that you understand what every setting means. If you adjust them randomly you may get into instabilities or your node may be unable to communicate at all. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
